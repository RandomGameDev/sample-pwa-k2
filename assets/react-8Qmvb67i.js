var me=Object.defineProperty;var We=(e,t,n)=>t in e?me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var V=(e,t,n)=>We(e,typeof t!="symbol"?t+"":t,n);import{a as x,U as H}from"./chunk-HA7DTUK3-BUh68AE2.js";var P=Symbol.for("bunshi.molecules.type"),ve=Symbol.for("bunshi.scope.type"),Se=Symbol.for("bunshi.injector.instance"),we=Symbol.for("bunshi.molecules.getter"),ye=Symbol.for("bunshi.molecules.molecule"),Re=Symbol.for("bunshi.molecules.molecule.interface"),se=Symbol.for("bunshi.injector.defaultGlobalInjector"),xe=Symbol("bunshi.debug"),X=Symbol("bunshi.scope.sort");function be(e,t){const n=ze++;let s;const l=Symbol((t==null?void 0:t.debugLabel)??`bunshi.scope ${n}`);return{defaultValue:e,[P]:ve,[xe]:l,[X]:n,get defaultTuple(){return s||(s=[this,e],s)}}}var ze=1,Ve=be(void 0,{debugLabel:"Component Scope"}),Le=0;function ke(){return Symbol(`bunshi.instance ${Le++}`)}var Ge="`mol` called asynchronously in a molecule constructor. Make sure your calls are only synchronous.",Ue="`scope` called asynchronously in a molecule constructor. Make sure your calls are only synchronous.",je="Unbound molecule interface. Could not find a molecule.",Ne="`scope` called with an object that is not a MoleculeScope",ge="`mol` called with an object that is not a Molecule or Interface",Pe="Global namespace conflict. Default injector is not a bunshi injector.",$e="Can only call `use` with a molecule, interface or scope";function Be(e){return[...e].sort((t,n)=>Fe(t[0],n[0]))}function Fe(e,t){return e[X]-t[X]}function $(e,t){return!e||typeof e!="object"?!1:e[P]===t}function N(e){return $(e,ye)}function ce(e){return $(e,ve)}function Y(e){return $(e,Re)}function Je(e){return $(e,Se)}var J=(e,t)=>{for(;;){const[n,...s]=t,l=e.get(n);if(!l)return;if(!s.length)return l[1];e=l[0],t=s}},ue=(e,t,n)=>{for(;;){const[s,...l]=t;let d=e.get(s);if(d||(d=[new WeakMap],e.set(s,d)),!l.length){d[1]=n;return}e=d[0],t=l}},Oe=()=>{let e=new WeakMap;return{get:d=>J(e,d),cache:e,deepCache:(d,f,w)=>{if(!w.length)throw new Error("Dependencies need to exist.");const _=J(e,w);if(_)return f(_),_;const y=d();return ue(e,w,y),y},upsert:(d,f)=>{if(!f.length)throw new Error("Dependencies need to exist.");const w=J(e,f),_=d(w);ue(e,f,_)},remove:(...d)=>{Ke(e,d)}}},Ke=(e,t)=>{for(;;){const[n,...s]=t;let l=e.get(n);if(!l)return;if(!s.length){l[1]=void 0;return}else e=l[0],t=s}},_e=class{constructor(){V(this,"_s",[]);V(this,"push",e=>{this._s.push(e)});V(this,"pop",()=>{this._s.pop()});V(this,"active",e=>{const t=this._s[this._s.length-1];if(!t)throw new Error(`Cannot call \`${e}\` outside of a molecule function`);return t})}},le=new _e,ae=new _e;function qe(e){const t=new WeakMap,n=new WeakSet,s=new WeakSet;function l(r){return r.map(c=>d(c))}function d(r){var c;const[S,a]=r,C=(c=t.get(S))==null?void 0:c.get(a);return C?C.tuple:r}function f(r,c){var S;const[a,C]=c,h=(S=t.get(a))==null?void 0:S.get(C);return h?(h.references.add(r),h.tuple):((t.get(a)??t.set(a,new Map).get(a)).set(C,{tuple:c,references:new Set([r]),cleanups:new Set}),c)}function w(r,c){return c.map(S=>f(r,S))}function _(r,c){if(s.has(c)||(s.add(c),!r))return;const S=y(r,c);Array.from(S.values()).reverse().forEach(a=>{n.has(a)||(e==null||e.scopeRunCleanup(a),a(),n.add(a))})}function y(r,c){const S=new Set;return r.forEach(([a,C])=>{const h=t.get(a),b=h==null?void 0:h.get(C),M=b==null?void 0:b.references;M==null||M.delete(c),M&&M.size<=0?(e==null||e.scopeStopWithCleanup(c,b),h==null||h.delete(C),b==null||b.cleanups.forEach(R=>{S.add(R)})):e==null||e.scopeStopWithCleanup(c,b)}),S}function T(r,c){r.forEach(([S,a])=>{c.forEach(C=>{var h,b;const M=(b=(h=t.get(S))==null?void 0:h.get(a))==null?void 0:b.cleanups;if(!M)throw new Error("Can't register cleanups for uncached values");M.add(C)})})}function A(...r){const c=E();return c.expand(r),c.start(),[c.tuples,()=>c.stop()]}function E(){let r=new u,c=!1;function S(){const a=r.tuples;return r=new u,r.expand(a),r.start()}return{addCleanups(a){T(this.tuples,a)},get tuples(){return r.tuples},expand(a){return r.expand(a)},start(){return c?(c=!1,S()):r.start()},stop(){r.stop(),c=!0}}}class u{constructor(){V(this,"__tupleMap",new Map);V(this,"__stableArray",[])}addCleanups(c){T(this.tuples,c)}get tuples(){return this.__stableArray}expand(c){const S=l(c);return S.forEach(a=>{this.__tupleMap.set(a[0],a)}),this.__stableArray=Array.from(this.__tupleMap.values()),S}start(){return w(this,this.__stableArray)}stop(){_(new Set(this.tuples),this)}}return{useScopes:A,registerCleanups:T,createSubscription:E}}var Qe=be(Symbol("bunshi.global.scope.value"),{debugLabel:"Global Scope"});function Xe(e){return e?Array.isArray(e)?new Map(e):new Map(e.entries()):new Map}function Ye(e={}){const t=Oe(),n=new WeakMap,s=Xe(e.bindings),l=qe(e.instrumentation);function d(u){const r=s.get(u);if(r)return r;if(N(u))return u;throw new Error(je)}function f(u,r){var c,S,a;(c=e.instrumentation)==null||c.getInternal(u);const C=n.get(u);if(C){const b=r.scopes.filter(o=>C.has(o[0])),M=ie(b,u),R=t.get(M);if(R)return R.deps.defaultScopes.forEach(o=>{r.lease(o.defaultTuple)}),(S=e.instrumentation)==null||S.stage1CacheHit(u,R),R}(a=e.instrumentation)==null||a.stage1CacheMiss();const{previous:h}=r;return h!==!1?t.deepCache(()=>h,()=>{},h.path):_(u,r)}function w(u,r,c,S){const a=ie(r,u);return t.deepCache(()=>({...c(),path:a,instanceId:ke()}),S,a)}function _(u,r){var c;const a=Ze(u,h=>{const b=new Set,M=r.scopes.find(([R])=>R===h);return M&&!(M[1]===M[0].defaultValue)?{value:M[1],defaultScopes:b}:(b.add(h),{value:h.defaultValue,defaultScopes:b})},h=>f(h,r),d);(c=e.instrumentation)==null||c.executed(u,a);const C=r.scopes.filter(([h])=>a.deps.allScopes.has(h));if(n.has(u)){const h=n.get(u);if(a.deps.allScopes.size!==(h==null?void 0:h.size))throw new Error("Molecule is using conditional dependencies. This is not supported.");let b=!1;if(a.deps.allScopes.forEach(M=>{h.has(M)||(b=!0)}),b)throw new Error("Molecule is using conditional dependencies. This is not supported.")}else n.set(u,a.deps.allScopes);return w(u,C,()=>{var h;a.deps.defaultScopes.forEach(M=>{r.lease(M.defaultTuple)});const b={deps:a.deps,value:a.value,isMounted:!1};return(h=e.instrumentation)==null||h.stage2CacheMiss(b),b},h=>{var b;h.deps.defaultScopes.forEach(M=>{r.lease(M.defaultTuple)}),(b=e.instrumentation)==null||b.stage2CacheHit(u,h)})}function y(u){var r;if(u.isMounted)return u;u.isMounted=!0,u.deps.buddies.forEach(y);const c=new Set;u.deps.mountedCallbacks.forEach(C=>{const h=C();h&&c.add(h)}),c.add(function(){var h;(h=e.instrumentation)==null||h.cleanup(u),t.remove(...u.path),u.isMounted=!1});const S=Array.from(u.deps.defaultScopes.values()).map(C=>C.defaultTuple);l.registerCleanups(S,c);const a=u.path.filter(C=>Array.isArray(C));return l.registerCleanups(a,c),(r=e==null?void 0:e.instrumentation)==null||r.mounted(u,a,c),u}function T(u,...r){const[c,S]=A(u,...r);return c}function A(u,...r){const[c,S]=E(u,...r);return[S.start(),S.stop]}function E(u,...r){if(!N(u)&&!Y(u))throw new Error(ge);const c=l.createSubscription(),S=c.expand(r),a=d(u);let C=0;const h=o=>{const[g]=c.expand([o]);return g};let b=f(a,{scopes:S,lease:h,previous:!1});const M=()=>{var o;if(C===1)throw new Error("Don't start a subscription that is already started.");return(o=e==null?void 0:e.instrumentation)==null||o.subscribe(a,b),b=f(a,{scopes:c.start(),lease:h,previous:b}),y(b),C=1,b.value},R=()=>{var o;if(C===2)throw new Error("Don't start a subscription that is already started.");(o=e==null?void 0:e.instrumentation)==null||o.unsubscribe(a,b),c.stop(),C=2};return[b.value,{start:M,stop:R}]}return{[P]:Se,get:T,use:A,useLazily:E,useScopes:l.useScopes,createSubscription:l.createSubscription}}function ie(e,t){const n=e.filter(l=>l[0].defaultValue!==l[1]);return[t,...Be(n)]}function Ze(e,t,n,s){const l=s(e),d=new Set,f=new Set,w=new Set,_=new Set,y=[],T=r=>{if(ce(r)){f.add(r);const c=t(r);return c.defaultScopes.forEach(S=>w.add(S)),c.value}if(N(r)||Y(r)){const c=s(r);d.add(c);const S=n(c);return S.deps.allScopes.forEach(a=>f.add(a)),S.deps.defaultScopes.forEach(a=>{w.add(a)}),y.push(S),S.value}throw new Error($e)},A=r=>{if(!u)throw new Error(Ue);if(!ce(r))throw new Error(Ne);return T(r)},E=r=>{if(!u)throw new Error(Ge);if(!N(r)&&!Y(r))throw new Error(ge);return T(r)};le.push(r=>_.add(r)),ae.push(T);let u=!0;A(Qe);try{const r=l[we](E,A);return{deps:{molecules:d,allScopes:f,defaultScopes:w,mountedCallbacks:_,buddies:y.slice().reverse()},value:r}}finally{u=!1,le.pop(),ae.pop()}}var He=()=>{const e=globalThis[se];if(e===void 0){const t=Ye();return globalThis[se]=t,t}if(Je(e))return e;throw new Error(Pe)};function et(e){return{[we]:e,[P]:ye}}const L={},de=(e,t)=>e.unstable_is?e.unstable_is(t):t===e,fe=e=>"init"in e,O=e=>!!e.write,pe=e=>"v"in e||"e"in e,j=e=>{if("e"in e)throw e.e;if((L?"production":void 0)!=="production"&&!("v"in e))throw new Error("[Bug] atom state is not initialized");return e.v},Ee=Symbol(),ee=e=>e[Ee],Z=e=>{var t;return te(e)&&!((t=ee(e))!=null&&t[1])},tt=(e,t)=>{const n=ee(e);if(n)n[1]=!0,n[0].forEach(s=>s(t));else if((L?"production":void 0)!=="production")throw new Error("[Bug] cancelable promise not found")},nt=e=>{if(ee(e))return;const t=[new Set,!1];e[Ee]=t;const n=()=>{t[1]=!0};e.then(n,n),e.onCancel=s=>{t[0].add(s)}},te=e=>typeof(e==null?void 0:e.then)=="function",Ce=(e,t,n)=>{n.p.has(e)||(n.p.add(e),t.then(()=>{n.p.delete(e)},()=>{n.p.delete(e)}))},K=(e,t,n)=>{const s=n(e),l="v"in s,d=s.v,f=Z(s.v)?s.v:null;if(te(t)){nt(t);for(const w of s.d.keys())Ce(e,t,n(w))}s.v=t,delete s.e,(!l||!Object.is(d,s.v))&&(++s.n,f&&tt(f,t))},he=(e,t,n)=>{var s;const l=new Set;for(const d of((s=n.get(e))==null?void 0:s.t)||[])n.has(d)&&l.add(d);for(const d of t.p)l.add(d);return l},rt=()=>{const e=new Set,t=()=>{e.forEach(n=>n())};return t.add=n=>(e.add(n),()=>{e.delete(n)}),t},q=()=>{const e={},t=new WeakMap,n=s=>{var l,d;(l=t.get(e))==null||l.forEach(f=>f(s)),(d=t.get(s))==null||d.forEach(f=>f())};return n.add=(s,l)=>{const d=s||e,f=(t.has(d)?t:t.set(d,new Set)).get(d);return f.add(l),()=>{f==null||f.delete(l),f.size||t.delete(d)}},n},ot=e=>(e.c||(e.c=q()),e.m||(e.m=q()),e.u||(e.u=q()),e.f||(e.f=rt()),e),st=Symbol(),ct=(e=new WeakMap,t=new WeakMap,n=new WeakMap,s=new Set,l=new Set,d=new Set,f={},w=(E,...u)=>E.read(...u),_=(E,...u)=>E.write(...u),y=(E,u)=>{var r;return(r=E.unstable_onInit)==null?void 0:r.call(E,u)},T=(E,u)=>{var r;return(r=E.onMount)==null?void 0:r.call(E,u)},...A)=>{const E=A[0]||(o=>{if((L?"production":void 0)!=="production"&&!o)throw new Error("Atom is undefined or null");let g=e.get(o);return g||(g={d:new Map,p:new Set,n:0},e.set(o,g),y==null||y(o,R)),g}),u=A[1]||(()=>{let o,g;const I=i=>{try{i()}catch(p){o||(o=!0,g=p)}};do{f.f&&I(f.f);const i=new Set,p=i.add.bind(i);s.forEach(v=>{var W;return(W=t.get(v))==null?void 0:W.l.forEach(p)}),s.clear(),d.forEach(p),d.clear(),l.forEach(p),l.clear(),i.forEach(I),s.size&&r()}while(s.size||d.size||l.size);if(o)throw g}),r=A[2]||(()=>{const o=[],g=new WeakSet,I=new WeakSet,i=Array.from(s);for(;i.length;){const p=i[i.length-1],v=E(p);if(I.has(p)){i.pop();continue}if(g.has(p)){if(n.get(p)===v.n)o.push([p,v]);else if((L?"production":void 0)!=="production"&&n.has(p))throw new Error("[Bug] invalidated atom exists");I.add(p),i.pop();continue}g.add(p);for(const W of he(p,v,t))g.has(W)||i.push(W)}for(let p=o.length-1;p>=0;--p){const[v,W]=o[p];let m=!1;for(const z of W.d.keys())if(z!==v&&s.has(z)){m=!0;break}m&&(c(v),C(v)),n.delete(v)}}),c=A[3]||(o=>{var g,I;const i=E(o);if(pe(i)&&(t.has(o)&&n.get(o)!==i.n||Array.from(i.d).every(([D,U])=>c(D).n===U)))return i;i.d.clear();let p=!0;const v=()=>{t.has(o)&&(C(o),r(),u())},W=D=>{var U;if(de(o,D)){const oe=E(D);if(!pe(oe))if(fe(D))K(D,D.init,E);else throw new Error("no atom init");return j(oe)}const F=c(D);try{return j(F)}finally{i.d.set(D,F.n),Z(i.v)&&Ce(o,i.v,F),(U=t.get(D))==null||U.t.add(o),p||v()}};let m,z;const B={get signal(){return m||(m=new AbortController),m.signal},get setSelf(){return(L?"production":void 0)!=="production"&&!O(o)&&console.warn("setSelf function cannot be used with read-only atom"),!z&&O(o)&&(z=(...D)=>{if((L?"production":void 0)!=="production"&&p&&console.warn("setSelf function cannot be called in sync"),!p)try{return a(o,...D)}finally{r(),u()}}),z}},G=i.n;try{const D=w(o,W,B);return K(o,D,E),te(D)&&((g=D.onCancel)==null||g.call(D,()=>m==null?void 0:m.abort()),D.then(v,v)),i}catch(D){return delete i.v,i.e=D,++i.n,i}finally{p=!1,G!==i.n&&n.get(o)===G&&(n.set(o,i.n),s.add(o),(I=f.c)==null||I.call(f,o))}}),S=A[4]||(o=>{const g=[o];for(;g.length;){const I=g.pop(),i=E(I);for(const p of he(I,i,t)){const v=E(p);n.set(p,v.n),g.push(p)}}}),a=A[5]||((o,...g)=>{let I=!0;const i=v=>j(c(v)),p=(v,...W)=>{var m;const z=E(v);try{if(de(o,v)){if(!fe(v))throw new Error("atom not writable");const B=z.n,G=W[0];K(v,G,E),C(v),B!==z.n&&(s.add(v),(m=f.c)==null||m.call(f,v),S(v));return}else return a(v,...W)}finally{I||(r(),u())}};try{return _(o,i,p,...g)}finally{I=!1}}),C=A[6]||(o=>{var g;const I=E(o),i=t.get(o);if(i&&!Z(I.v)){for(const[p,v]of I.d)if(!i.d.has(p)){const W=E(p);h(p).t.add(o),i.d.add(p),v!==W.n&&(s.add(p),(g=f.c)==null||g.call(f,p),S(p))}for(const p of i.d||[])if(!I.d.has(p)){i.d.delete(p);const v=b(p);v==null||v.t.delete(o)}}}),h=A[7]||(o=>{var g;const I=E(o);let i=t.get(o);if(!i){c(o);for(const p of I.d.keys())h(p).t.add(o);if(i={l:new Set,d:new Set(I.d.keys()),t:new Set},t.set(o,i),(g=f.m)==null||g.call(f,o),O(o)){const p=()=>{let v=!0;const W=(...m)=>{try{return a(o,...m)}finally{v||(r(),u())}};try{const m=T(o,W);m&&(i.u=()=>{v=!0;try{m()}finally{v=!1}})}finally{v=!1}};l.add(p)}}return i}),b=A[8]||(o=>{var g;const I=E(o);let i=t.get(o);if(i&&!i.l.size&&!Array.from(i.t).some(p=>{var v;return(v=t.get(p))==null?void 0:v.d.has(o)})){i.u&&d.add(i.u),i=void 0,t.delete(o),(g=f.u)==null||g.call(f,o);for(const p of I.d.keys()){const v=b(p);v==null||v.t.delete(o)}return}return i}),M=[e,t,n,s,l,d,f,w,_,y,T,E,u,r,c,S,a,C,h,b],R={get:o=>j(c(o)),set:(o,...g)=>{try{return a(o,...g)}finally{r(),u()}},sub:(o,g)=>{const i=h(o).l;return i.add(g),u(),()=>{i.delete(g),b(o),u()}}};return Object.defineProperty(R,st,{value:M}),R},Me=ct,ut=ot,ne={};let lt=0;function at(e,t){const n=`atom${++lt}`,s={toString(){return(ne?"production":void 0)!=="production"&&this.debugLabel?n+":"+this.debugLabel:n}};return typeof e=="function"?s.read=e:(s.init=e,s.read=it,s.write=dt),s}function it(e){return e(this)}function dt(e,t,n){return t(this,typeof n=="function"?n(e(this)):n)}const ft=()=>{let e=0;const t=ut({}),n=new WeakMap,s=new WeakMap,l=Me(n,s,void 0,void 0,void 0,void 0,t,void 0,(w,_,y,...T)=>e?y(w,...T):w.write(_,y,...T)),d=new Set;return t.m.add(void 0,w=>{d.add(w);const _=n.get(w);_.m=s.get(w)}),t.u.add(void 0,w=>{d.delete(w);const _=n.get(w);delete _.m}),Object.assign(l,{dev4_get_internal_weak_map:()=>n,dev4_get_mounted_atoms:()=>d,dev4_restore_atoms:w=>{const _={read:()=>null,write:(y,T)=>{++e;try{for(const[A,E]of w)"init"in A&&T(A,E)}finally{--e}}};l.set(_)}})},pt=()=>(ne?"production":void 0)!=="production"?ft():Me();let k;const ht=()=>(k||(k=pt(),(ne?"production":void 0)!=="production"&&(globalThis.__JOTAI_DEFAULT_STORE__||(globalThis.__JOTAI_DEFAULT_STORE__=k),globalThis.__JOTAI_DEFAULT_STORE__!==k&&console.warn("Detected multiple Jotai instances. It may cause unexpected behavior with the default store. https://github.com/pmndrs/jotai/discussions/2044"))),k),Ie={},vt=x.createContext(void 0),Te=e=>x.useContext(vt)||ht(),Ae=e=>typeof(e==null?void 0:e.then)=="function",St=e=>{e.status="pending",e.then(t=>{e.status="fulfilled",e.value=t},t=>{e.status="rejected",e.reason=t})},wt=H.use||(e=>{if(e.status==="pending")throw e;if(e.status==="fulfilled")return e.value;throw e.status==="rejected"?e.reason:(St(e),e)}),Q=new WeakMap,yt=e=>{let t=Q.get(e);return t||(t=new Promise((n,s)=>{let l=e;const d=_=>y=>{l===_&&n(y)},f=_=>y=>{l===_&&s(y)},w=_=>{"onCancel"in _&&typeof _.onCancel=="function"&&_.onCancel(y=>{if((Ie?"production":void 0)!=="production"&&y===_)throw new Error("[Bug] p is not updated even after cancelation");Ae(y)?(Q.set(y,t),l=y,y.then(d(y),f(y)),w(y)):n(y)})};e.then(d(e),f(e)),w(e)}),Q.set(e,t)),t};function Mt(e,t){const n=Te(),[[s,l,d],f]=x.useReducer(y=>{const T=n.get(e);return Object.is(y[0],T)&&y[1]===n&&y[2]===e?y:[T,n,e]},void 0,()=>[n.get(e),n,e]);let w=s;if((l!==n||d!==e)&&(f(),w=n.get(e)),x.useEffect(()=>{const y=n.sub(e,()=>{f()});return f(),y},[n,e,void 0]),x.useDebugValue(w),Ae(w)){const y=yt(w);return wt(y)}return w}function It(e,t){const n=Te();return x.useCallback((...l)=>{if((Ie?"production":void 0)!=="production"&&!("write"in e))throw new Error("not writable atom");return n.set(e,...l)},[n,e])}const Tt=et(()=>({cartAtom:at([])}));var De=H.createContext([]);De.displayName="BunshiMoleculeScopeContext";function bt(e){return e.flatMap(t=>t)}var re=H.createContext(()=>He());re.displayName="BunshiMoleculeInjectorContext";function gt(){return x.useContext(re)()}function _t(e){const t=x.useContext(De),n=x.useMemo(()=>new Error("Do not use this scope value. It is a placeholder only."),[]),s=x.useRef([Ve,n]).current;return[...t,s]}function At(e,t){const n=gt(),s=_t(),[l,d]=x.useMemo(()=>n.useLazily(e,...s),[e,n,...bt(s)]),[f,w]=x.useState(()=>l);return x.useEffect(()=>{const _=d.start();return w(()=>_),()=>{d.stop()}},[d]),f}re.Provider;export{Tt as C,Mt as a,It as b,At as u};
